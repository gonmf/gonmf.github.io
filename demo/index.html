<html>
  <head>
    <script>
      rand = function(min, max) {
        return Math.round(Math.random() * (max - min) + min)
      }

      reset = function(nextRound) {
        window.gs = {
          bgColor: `rgb(${rand(30, 70)}, ${rand(0, 40)}, ${rand(50, 150)})`,
          frameCounter: 0,
          ctx: document.getElementById("myCanvas").getContext("2d"),
          charLife: 20,
          oppoLife: 20,
          charStamina: 10,
          oppoStamina: 10,
          charStun: 0,
          oppoStun: 0,
          charAnimation: "defend",
          charAnimLeft: 20,
          oppoAnimation: "defend",
          oppoAnimLeft: 20,
          round: nextRound || 1,
          oppoAi: false,
        }

        document.getElementById("roundNrSpan").innerText = gs.round
      }

      toggleAi = function() {
        gs.oppoAi = !gs.oppoAi
        document.getElementById("aiButton").innerText = `Opponent AI: ${gs.oppoAi ? 'on' : 'off'}`
      }

      onLoad = function() {
        var drawBackground = function() {
          var ctx = gs.ctx
          var grd = ctx.createLinearGradient(0, 0, 0, 600);
          grd.addColorStop(0, gs.bgColor);
          grd.addColorStop(1, "#aaa");
          ctx.fillStyle = grd;
          ctx.fillRect(0, 0, 400, 300);

          grd = ctx.createLinearGradient(0, 0, 0, 600);
          grd.addColorStop(0, "#aaa");
          grd.addColorStop(1, gs.bgColor);
          ctx.fillStyle = grd;
          ctx.fillRect(0, 300, 400, 600);
        }

        var bob = function(frameCounter, range, frames_per_tick) {
          const current = (frameCounter / frames_per_tick) % range
          return (current < range / 2) ? current : range - current
        }

        var transition = function(start, end, framesLeft, framesToStatic, framesTotal) {
          if (framesLeft < framesToStatic) {
            var progress = (framesLeft / framesToStatic)
            return Math.round(((1 - progress) * start + progress * end) / 2)
          }
          if (framesLeft < framesTotal - framesToStatic) {
            return end
          }
          var progress = ((framesTotal - framesLeft) / framesToStatic)
          return Math.round(((1 - progress) * start + progress * end) / 2)
        }

        var drawCharLeftArm = function() {
          var ctx = gs.ctx
          var frameCounter = gs.frameCounter
          var stunnedShiftLeftRight = (gs.oppoAnimation === 'punch_left' || gs.oppoAnimation === 'punch_right') && gs.oppoAnimLeft < 5 ? rand(0, 18) : 0
          var stunnedShiftTopDown = (gs.oppoAnimation === 'punch_left' || gs.oppoAnimation === 'punch_right') && gs.oppoAnimLeft < 5 ? rand(0, 18) : 0
          var bobLeftRight = gs.charAnimation ? 0 : bob(frameCounter, 20, 3);
          var bobUpDown = gs.charAnimation ? 0 : bob(frameCounter, 8, 2);
          if (gs.charAnimation === "punch_left") {
            if (gs.charAnimLeft > 3) {
              var img = document.getElementById("left_arm");
              ctx.drawImage(img, transition(40, 70, gs.charAnimLeft, 4, 24) + bobLeftRight, 200 + bobUpDown);
              return
            }
            var img = document.getElementById("char_left_punch");
            ctx.drawImage(img, 50 + bobLeftRight, transition(300, 250, gs.charAnimLeft, 4, 8) + bobUpDown);
          } else if (gs.charAnimation === "defend" || (gs.charAnimation === "punch_right" && gs.charAnimLeft <= 3)) {
            var img = document.getElementById("left_arm");
            ctx.drawImage(img, transition(40, 70, gs.charAnimLeft, 4, 24) + bobLeftRight + stunnedShiftLeftRight, 200 + bobUpDown + stunnedShiftTopDown);
          } else {
            var img = document.getElementById("left_arm");
            ctx.drawImage(img, 40 + bobLeftRight + stunnedShiftLeftRight, 200 + bobUpDown + stunnedShiftTopDown);
          }
        }

        var drawCharRightArm = function() {
          var ctx = gs.ctx
          var frameCounter = gs.frameCounter
          var stunnedShiftLeftRight = (gs.oppoAnimation === 'punch_left' || gs.oppoAnimation === 'punch_right') && gs.oppoAnimLeft < 5 ? rand(0, 18) : 0
          var stunnedShiftTopDown = (gs.oppoAnimation === 'punch_left' || gs.oppoAnimation === 'punch_right') && gs.oppoAnimLeft < 5 ? rand(0, 18) : 0
          var bobLeftRight = gs.charAnimation ? 0 : bob(frameCounter, 20, 3);
          var bobUpDown = gs.charAnimation ? 0 : bob(frameCounter, 8, 2);
          if (gs.charAnimation === "punch_right") {
            if (gs.charAnimLeft > 3) {
              var img = document.getElementById("right_arm");
              ctx.drawImage(img, transition(-40, -70, gs.charAnimLeft, 4, 24) + bobLeftRight, 200 + bobUpDown);
              return
            }
            var img = document.getElementById("char_right_punch");
            ctx.drawImage(img, 150 + bobLeftRight, transition(300, 250, gs.charAnimLeft, 4, 8) + bobUpDown);
          } else if (gs.charAnimation === "defend" || (gs.charAnimation === "punch_left" && gs.charAnimLeft <= 3)) {
            var img = document.getElementById("right_arm");
            ctx.drawImage(img, transition(-40, -70, gs.charAnimLeft, 4, 24) + bobLeftRight + stunnedShiftLeftRight, 200 + bobUpDown + stunnedShiftTopDown);
          } else {
            var img = document.getElementById("right_arm");
            ctx.drawImage(img, -40 + bobLeftRight + stunnedShiftLeftRight, 200 + bobUpDown + stunnedShiftTopDown);
          }
        }

        var drawCharacter = function() {
          if (gs.charAnimation !== 'lost') {
            drawCharLeftArm();
            drawCharRightArm();
          }

          var ctx = gs.ctx
          var frameCounter = gs.frameCounter
          var img = document.getElementById("char");
          var goingDown = gs.charAnimation === 'lost' ? (120 - gs.charAnimLeft) * 2 : 0
          var stunnedShiftLeftRight = gs.charStun > 0 ? rand(0, 18) : 0
          var stunnedShiftTopDown = gs.charStun > 0 ? rand(0, 18) : 0
          var bobLeftRight = gs.charAnimation ? 0 : bob(frameCounter, 20, 2);
          var bobUpDown = gs.charAnimation ? 0 : bob(frameCounter, 8, 2);
          ctx.drawImage(img, bobLeftRight + stunnedShiftLeftRight, 280 + bobUpDown + goingDown + stunnedShiftTopDown);
        }

        var drawOppoLeftArm = function() {
          var ctx = gs.ctx
          var frameCounter = gs.frameCounter
          var stunnedShiftLeftRight = (gs.charAnimation === 'punch_left' || gs.charAnimation === 'punch_right') && gs.charAnimLeft < 5 ? rand(0, 18) : 0
          var stunnedShiftTopDown = (gs.charAnimation === 'punch_left' || gs.charAnimation === 'punch_right') && gs.charAnimLeft < 5 ? rand(0, 18) : 0
          var bobLeftRight = gs.oppoAnimation ? 0 : bob(frameCounter, 30, 3);
          var bobUpDown = gs.oppoAnimation ? 0 : bob(frameCounter, 8, 2);
          if (gs.oppoAnimation === "punch_left") {
            if (gs.oppoAnimLeft > 3) {
              var img = document.getElementById("oppo_left");
              ctx.drawImage(img, transition(-20, 0, gs.oppoAnimLeft, 4, 24) + bobLeftRight, transition(30, 15, gs.oppoAnimLeft, 4, 24) + bobUpDown);
              return
            }
            var img = document.getElementById("oppo_left_punch");
            ctx.drawImage(img, -30 + bobLeftRight, transition(180, 250, gs.oppoAnimLeft, 4, 8) + bobUpDown);
          } else if (gs.oppoAnimation === "defend" || (gs.oppoAnimation === "punch_right" && gs.oppoAnimLeft <= 3)) {
            var img = document.getElementById("oppo_left");
            ctx.drawImage(img, transition(-20, 0, gs.oppoAnimLeft, 4, 24) + bobLeftRight + stunnedShiftLeftRight, transition(30, 15, gs.oppoAnimLeft, 4, 24) + bobUpDown + stunnedShiftTopDown);
          } else {
            var img = document.getElementById("oppo_left");
            ctx.drawImage(img, -20 + bobLeftRight + stunnedShiftLeftRight, 30 + bobUpDown + stunnedShiftTopDown);
          }
        }

        var drawOppoRightArm = function() {
          var ctx = gs.ctx
          var frameCounter = gs.frameCounter
          var stunnedShiftLeftRight = (gs.charAnimation === 'punch_left' || gs.charAnimation === 'punch_right') && gs.charAnimLeft < 5 ? rand(0, 18) : 0
          var stunnedShiftTopDown = (gs.charAnimation === 'punch_left' || gs.charAnimation === 'punch_right') && gs.charAnimLeft < 5 ? rand(0, 18) : 0
          var bobLeftRight = gs.oppoAnimation ? 0 : bob(frameCounter, 30, 3);
          var bobUpDown = gs.oppoAnimation ? 0 : bob(frameCounter, 8, 2);
          if (gs.oppoAnimation === "punch_right") {
            if (gs.oppoAnimLeft > 3) {
              var img = document.getElementById("oppo_right");
              ctx.drawImage(img, transition(20, 0, gs.oppoAnimLeft, 4, 24) + bobLeftRight, transition(30, 15, gs.oppoAnimLeft, 4, 24) + bobUpDown);
              return
            }
            var img = document.getElementById("oppo_right_punch");
            ctx.drawImage(img, 30 + bobLeftRight, transition(180, 250, gs.oppoAnimLeft, 4, 8) + bobUpDown);
          } else if (gs.oppoAnimation === "defend" || (gs.oppoAnimation === "punch_left" && gs.oppoAnimLeft <= 3)) {
            var img = document.getElementById("oppo_right");
            ctx.drawImage(img, transition(20, 0, gs.oppoAnimLeft, 4, 24) + bobLeftRight + stunnedShiftLeftRight, transition(30, 15, gs.oppoAnimLeft, 4, 24) + bobUpDown + stunnedShiftTopDown);
          } else {
            var img = document.getElementById("oppo_right");
            ctx.drawImage(img, 20 + bobLeftRight + stunnedShiftLeftRight, 30 + bobUpDown + stunnedShiftTopDown);
          }
        }

        var drawOpponent = function() {
          var ctx = gs.ctx
          var frameCounter = gs.frameCounter
          var img = document.getElementById("oppo_body");
          var stunnedShiftLeftRight = gs.oppoStun > 0 ? rand(0, 18) : 0
          var stunnedShiftTopDown = gs.oppoStun > 0 ? rand(0, 18) : 0
          var goingDown = gs.oppoAnimation === 'lost' ? (120 - gs.oppoAnimLeft) * 2 : 0
          var bobLeftRight = gs.oppoAnimation ? 0 : bob(frameCounter, 30, 2);
          var bobUpDown = gs.oppoAnimation ? 0 : bob(frameCounter, 8, 2);
          ctx.drawImage(img, bobLeftRight + stunnedShiftLeftRight, 0 + bobUpDown + goingDown + stunnedShiftTopDown);

          if (gs.oppoAnimation !== 'lost') {
            drawOppoLeftArm();
            drawOppoRightArm();
          }
        }

        var charCanAct = function() {
          return gs.charAnimLeft === 0 && gs.charStun === 0
        }

        var oppoCanAct = function() {
          return gs.oppoAnimLeft === 0 && gs.oppoStun === 0
        }

        window.oppoPunchLeft = function() {
          if (!oppoCanAct() || gs.oppoStamina < 4) {
            return
          }

          gs.oppoAnimLeft = 8
          gs.oppoAnimation = 'punch_left'
          gs.oppoStamina -= 4
        }

        window.oppoPunchRight = function() {
          if (!oppoCanAct() || gs.oppoStamina < 4) {
            return
          }

          gs.oppoAnimLeft = 8
          gs.oppoAnimation = 'punch_right'
          gs.oppoStamina -= 4
        }

        window.oppoDefend = function() {
          if (!oppoCanAct() || gs.oppoStamina < 2) {
            return
          }

          gs.oppoAnimLeft = 24
          gs.oppoAnimation = 'defend'
          gs.oppoStamina -= 2
        }

        window.charPunchLeft = function() {
          if (!charCanAct() || gs.charStamina < 4) {
            return
          }

          gs.charAnimLeft = 8
          gs.charAnimation = 'punch_left'
          gs.charStamina -= 4
        }

        window.charPunchRight = function() {
          if (!charCanAct() || gs.charStamina < 4) {
            return
          }

          gs.charAnimLeft = 8
          gs.charAnimation = 'punch_right'
          gs.charStamina -= 4
        }

        window.charDefend = function() {
          if (!charCanAct() || gs.charStamina < 2) {
            return
          }

          gs.charAnimLeft = 24
          gs.charAnimation = 'defend'
          gs.charStamina -= 2
        }

        var setButtonsEnabledDisabled = function() {
          var gameover = gs.charLife <= 0 || gs.oppoLife <= 0

          const charCanAct1 = !gameover && charCanAct()
          document.getElementById("charPunchLeft").disabled = !charCanAct1 || gs.charStamina < 4
          document.getElementById("charDefend").disabled = !charCanAct1
          document.getElementById("charPunchRight").disabled = !charCanAct1 || gs.charStamina < 4

          const oppoCanAct1 = !gs.oppoAi && !gameover && oppoCanAct()
          document.getElementById("oppoPunchLeft").disabled = !oppoCanAct1 || gs.oppoStamina < 4
          document.getElementById("oppoDefend").disabled = !oppoCanAct1
          document.getElementById("oppoPunchRight").disabled = !oppoCanAct1 || gs.oppoStamina < 4
        }

        var drawText = function() {
          var ctx = gs.ctx
          ctx.fillStyle = "white"
          ctx.font = "24px Arial";
          var doubleKo = false

          if (gs.oppoLife <= 0) {
            if (gs.charLife <= 0) {
              ctx.fillText(`DOUBLE KO`, 140, 310);
              doubleKo = true
            }
            if (!doubleKo) {
              ctx.fillText(`K O`, 180, 40);
            }
          } else {
            ctx.fillText(`Life: ${gs.oppoLife}`, 20, 40);
            ctx.fillText(`Stamina: ${gs.oppoStamina}`, 260, 40);
          }

          if (gs.charLife <= 0) {
            if (!doubleKo) {
              ctx.fillText(`K O`, 180, 580);
            }
          } else {
            ctx.fillText(`Life: ${gs.charLife}`, 20, 580);
            ctx.fillText(`Stamina: ${gs.charStamina}`, 260, 580);
          }
        }

        var aiAction = function() {
          if (!gs.oppoAi || gs.oppoLife <= 0 || gs.oppoAnimLeft > 0 || gs.oppoStun > 0) {
            return
          }

          if (rand(0, 32) > 1) {
            return
          }

          if (gs.oppoLife < 10) {
            var action = rand(0, 5)
            if (action > 2) {
              window.oppoDefend()
              return
            }
            if (action > 1) {
              window.oppoPunchLeft()
              return
            }
            if (action > 0) {
              window.oppoPunchRight()
              return
            }
          }

          if (gs.oppoStamina < 5) {
            var action = rand(0, 8)
            if (action > 6) {
              window.oppoDefend()
              return
            }
            if (action > 5) {
              window.oppoPunchLeft()
              return
            }
            if (action > 4) {
              window.oppoPunchRight()
              return
            }
          }

          if (gs.charAnimation === 'punch_left' || gs.charAnimation === 'punch_right') {
            var action = rand(0, 12)
            if (action > 9) {
              window.oppoDefend()
              return
            }
            if (action > 8) {
              window.oppoPunchLeft()
              return
            }
            if (action > 7) {
              window.oppoPunchRight()
              return
            }
          }

          var action = rand(0, 4)
          if (action > 2) {
            window.oppoDefend()
            return
          }
          if (action > 1) {
            window.oppoPunchLeft()
            return
          }
          if (action > 0) {
            window.oppoPunchRight()
            return
          }
        }

        var sceneRefresh = function() {
          gs.frameCounter += 1

          setButtonsEnabledDisabled();
          drawBackground();
          drawOpponent();
          drawCharacter();
          drawText();

          var gameover = gs.charLife <= 0 || gs.oppoLife <= 0
          if (gameover) {
            if (gs.charLife <= 0 && gs.charAnimation !== 'lost') {
              gs.charAnimation = 'lost'
              gs.charAnimLeft = 120
            }
            if (gs.oppoLife <= 0 && gs.oppoAnimation !== 'lost') {
              gs.oppoAnimation = 'lost'
              gs.oppoAnimLeft = 120
            }
          }

          if (!gameover) {
            if ((gs.frameCounter % 32) === 0) {
              if ((!gs.charAnimation) && gs.charStamina < 10) {
                gs.charStamina += 1
              }
              if ((!gs.oppoAnimation) && gs.oppoStamina < 10) {
                gs.oppoStamina += 1
              }
            }

            if (gs.charStun > 0) {
              gs.charStun -= 1
            }
            if (gs.oppoStun > 0) {
              gs.oppoStun -= 1
            }
          }

          if (gs.charAnimLeft > 0) {
            gs.charAnimLeft -= 1
            if (gs.charAnimLeft === 0) {
              if (gs.charAnimation === 'lost') {
                window.reset(gs.round + 1)
                return
              } else {
                gs.charAnimation = undefined
              }
            } else if (!gameover && (gs.charAnimation == 'punch_left' || gs.charAnimation == 'punch_right') && gs.charAnimLeft === 4) {
              if (gs.oppoAnimation === 'defend') {
                gs.oppoLife -= 1
              } else if (!gs.oppoAnimation) {
                gs.oppoLife -= 4
                gs.oppoStun = 8
              } else if (gs.charAnimation === gs.oppoAnimation) {
                gs.oppoLife -= 2
                gs.oppoStun = 4
              } else {
                gs.oppoLife -= 2
              }
            }
          }
          if (gs.oppoAnimLeft > 0) {
            gs.oppoAnimLeft -= 1
            if (gs.oppoAnimLeft === 0) {
              if (gs.oppoAnimation == 'lost') {
                window.reset(gs.round + 1);
                return
              } else {
                gs.oppoAnimation = undefined
              }
            } else if (!gameover && (gs.oppoAnimation == 'punch_left' || gs.oppoAnimation == 'punch_right') && gs.oppoAnimLeft === 4) {
              if (gs.charAnimation === 'defend') {
                gs.charLife -= 1
              } else if (!gs.charAnimation) {
                gs.charLife -= 4
                gs.charStun = 8
              } else if (gs.charAnimation === gs.oppoAnimation) {
                gs.charLife -= 2
                gs.charStun = 4
              } else {
                gs.charLife -= 2
              }
            }
          }

          aiAction()
        }

        window.reset()

        setInterval(sceneRefresh, 25)
      }
    </script>
  </head>

  <body onload="onLoad()" style="color: white; background-color: #000; text-align: center;">
    <!-- <button onclick="window.reset()">Reset</button>
    <br/> -->
    <button id="aiButton" onclick="window.toggleAi()">Opponent AI: off</button>
    <br/>
    <h1 style="display: none">Round <span id="roundNrSpan">1</span> / 8</h1>
    <button id="oppoPunchLeft" onclick="window.oppoPunchLeft()">Punch left arm</button>
    <button id="oppoDefend" onclick="oppoDefend()">Defend w both arms</button>
    <button id="oppoPunchRight" onclick="oppoPunchRight()">Punch right arm</button>
    <br/>
    <canvas id="myCanvas" width="400" height="600" style="border:1px solid rgb(54, 10, 116);"></canvas>
    <br/>
    <button id="charPunchLeft" onclick="charPunchLeft()">Punch left arm</button>
    <button id="charDefend" onclick="charDefend()">Defend w both arms</button>
    <button id="charPunchRight" onclick="charPunchRight()">Punch right arm</button>
    <br/>
    <img style="display: none" id="char" src="img/char.png" />
    <img style="display: none" id="left_arm" src="img/left_arm.png" />
    <img style="display: none" id="oppo_body" src="img/oppo_body.png" />
    <img style="display: none" id="oppo_left" src="img/oppo_left.png" />
    <img style="display: none" id="oppo_right" src="img/oppo_right.png" />
    <img style="display: none" id="right_arm" src="img/right_arm.png" />
    <img style="display: none" id="char_left_punch" src="img/char_left_punch.png" />
    <img style="display: none" id="char_right_punch" src="img/char_right_punch.png" />
    <img style="display: none" id="oppo_left_punch" src="img/oppo_left_punch.png" />
    <img style="display: none" id="oppo_right_punch" src="img/oppo_right_punch.png" />
  </body>
</html>
